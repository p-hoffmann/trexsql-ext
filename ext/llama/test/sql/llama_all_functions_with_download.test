# name: test/sql/llama_all_functions_with_download.test
# description: Test all SQL functions by downloading a minimal model
# group: [sql]

require llama

# Download a very small GGUF model for testing (using a reliable, fast source)
# This uses a Q4_K_M quantized TinyLlama model which is small but functional

# Test 2: Download a small TinyLlama model for comparison testing
statement ok
SELECT llama_download_model('https://huggingface.co/aladar/TinyLLama-v0-GGUF/resolve/main/TinyLLama-v0.Q8_0.gguf', 'TinyLlama-test.gguf');

# Test 3: Verify download
query I
SELECT llama_list_models() LIKE '%TinyLlama%';
----
true

# Test 1: Basic functions without requiring a loaded model
query I 
SELECT llama_gpu_info() IS NOT NULL;
----
true

query I
SELECT llama_status() IS NOT NULL;
----
true

query I
SELECT llama_list_models() LIKE '%TinyLlama%';
----
true

# Test 3: Verify download
query I
SELECT llama_list_models() LIKE '%TinyLlama-test%';
----
true

# Test 4: Load the model
statement ok
SELECT llama_load_model('/home/ph/.local/share/duckdb-llama/models/TinyLlama-test.gguf', '{"n_ctx": 512, "n_gpu_layers": 0}');

# Test 5: Verify model is loaded
query I
SELECT llama_list_loaded() LIKE '%TinyLlama-test%';
----
true

# Test 4: Get detailed model information
query I
SELECT llama_model_info('TinyLlama-test') IS NOT NULL;
----
true

# Test 5: Basic text generation
query I
SELECT LENGTH(llama_generate('TinyLlama-test', 'Hello world', '{"max_tokens": 3, "temperature": 0.1}')) > 0;
----
true

# Test 6: Chat interface
statement ok
SELECT llama_chat('TinyLlama-test', '[{"role":"user","content":"Say hi"}]', '{"max_tokens": 3}');

# Test 7: Load separate instance for embeddings
statement ok
SELECT llama_load_model_for_embeddings('TinyLlama-test', '{"n_ctx": 128}');

# Test 8: Generate embeddings
query I
SELECT llama_embed('TinyLlama-test', 'Hello') LIKE '%vector%' OR 
       llama_embed('TinyLlama-test', 'Hello') LIKE '%embedding%' OR
       LENGTH(llama_embed('TinyLlama-test', 'Hello')) > 20;
----
true

# Test 9: Batch processing
query I
SELECT llama_batch_process('{"model":"TinyLlama-test","requests":[{"id":1,"prompt":"Hi","max_tokens":2}]}') IS NOT NULL;
----
true

# Test 10: Error handling - try to use non-existent model
query I
SELECT llama_generate('nonexistent-model', 'test') LIKE '%Error%' OR 
       llama_generate('nonexistent-model', 'test') LIKE '%not loaded%' OR
       llama_generate('nonexistent-model', 'test') LIKE '%not found%';
----
true

# Test 11: Download function error handling
query I
SELECT llama_download_model('invalid://not-a-real-url', 'test.gguf') IS NOT NULL;
----
true

# Test 12: Load model with custom config
statement ok
SELECT llama_load_model('/home/ph/.local/share/duckdb-llama/models/TinyLlama-test.gguf', '{"n_ctx": 512, "n_gpu_layers": -1}');

# Test 13: Test all generation parameters
query I
SELECT LENGTH(llama_generate('TinyLlama-test', 'Test', 
    '{"max_tokens": 5, "temperature": 0.5, "top_p": 0.9, "top_k": 40}')) > 0;
----
true

# Test 14: Test chat with multiple messages
statement ok  
SELECT llama_chat('TinyLlama-test', 
    '[{"role":"system","content":"Be helpful"},{"role":"user","content":"Hi"}]',
    '{"max_tokens": 5}');

# Test 15: Cleanup - unload model
statement ok
SELECT llama_unload_model('TinyLlama-test');

# Test 16: Verify unload worked
query I
SELECT llama_list_loaded() NOT LIKE '%TinyLlama%' OR llama_list_loaded() LIKE '%No models%';
----
true

# Test 17: Test loading with JSON containing model path
statement ok
SELECT llama_load_model_for_embeddings('/home/ph/.local/share/duckdb-llama/models/TinyLlama-test.gguf', '{"n_ctx": 64}');

# Final cleanup
statement ok
SELECT llama_unload_model('TinyLlama-test');

statement ok
SELECT 'All function tests completed successfully';
