# name: test/sql/pgwire.test
# description: test pgwire extension
# group: [pgwire]

# Before we load the extension, this will fail
statement error
SELECT trex_pgwire_start('127.0.0.1', 5433, 'password', 'db_credentials');
----
Catalog Error: Scalar Function with name trex_pgwire_start does not exist!

# Require statement will ensure the extension is loaded from now on
require pgwire

# Confirm the extension works
query IIII
SELECT * FROM trex_pgwire_status();
----

# Test starting a server with credentials
query I
SELECT trex_pgwire_start('127.0.0.1', 5433, 'test_password', 'host=localhost;user=test;password=secret');
----
Started pgwire server on 127.0.0.1:5433

# Check server status after starting
query IIII
SELECT * FROM trex_pgwire_status();
----
127.0.0.1	5433	0	true

# Test updating database credentials
query I
SELECT trex_pgwire_set_credentials('127.0.0.1', 5433, 'host=localhost;user=updated;password=newsecret');
----
Database credentials updated for server 127.0.0.1:5433

# Test updating credentials for non-existent server
query I
SELECT trex_pgwire_set_credentials('127.0.0.1', 9999, 'some_credentials');
----
Error: No server running on 127.0.0.1:9999

# Stop the server
query I
SELECT trex_pgwire_stop('127.0.0.1', 5433);
----
Shutdown signal sent to server 127.0.0.1:5433