.PHONY: clean clean_all

PROJ_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))

EXTENSION_NAME=trexas

# Set to 1 to enable Unstable API (binaries will only work on TARGET_DUCKDB_VERSION, forwards compatibility will be broken)
# Note: currently extension-template-rs requires this, as duckdb-rs relies on unstable C API functionality
USE_UNSTABLE_C_API=1

# Target DuckDB version
TARGET_DUCKDB_VERSION=v1.4.4

# Override target path â€” standalone crate (not workspace member)
TARGET_PATH=./target

# Use cargo --target-dir to build directly in the expected location
export CARGO_TARGET_DIR := $(PROJ_DIR)target

# Use system oniguruma library instead of building from source to avoid GCC14 incompatibility
# export RUSTONIG_SYSTEM_LIBONIG := 1

# Enable tracing feature for CLI dependency
export CARGO_FEATURES :=
CARGO_OVERRIDE_DUCKDB_RS_FLAG :=

# export V8_FROM_SOURCE := 1
# export EXTRA_GN_ARGS := v8_monolithic=true v8_monolithic_for_shared_library=true

all: configure debug

# Include makefiles from DuckDB
include extension-ci-tools/makefiles/c_api_extensions/base.Makefile
include extension-ci-tools/makefiles/c_api_extensions/rust.Makefile

configure: venv platform extension_version

debug: build_extension_library_debug build_extension_with_metadata_debug
release: build_extension_library_release build_extension_with_metadata_release

test: test_debug
test_debug: test_extension_debug
test_release: test_extension_release

# ASAN (AddressSanitizer) build for memory debugging
# Requires: nightly Rust, clang
# Usage: make asan
# Run with: ASAN_OPTIONS=detect_leaks=1 ./target/debug/...
asan:
	@echo "Building with AddressSanitizer enabled..."
	@echo "Note: Requires nightly Rust toolchain"
	RUSTFLAGS="-Zsanitizer=address" \
	CFLAGS="-fsanitize=address -fno-omit-frame-pointer" \
	CXXFLAGS="-fsanitize=address -fno-omit-frame-pointer" \
	CC=clang CXX=clang++ \
	cargo +nightly build -Zbuild-std --target x86_64-unknown-linux-gnu

# Debug GC build - enables V8 GC tracing
# Usage: TREX_DEBUG_GC=1 ./target/debug/trex ...
debug_gc: debug
	@echo "Debug build complete. Run with TREX_DEBUG_GC=1 to enable GC tracing"
	@echo "Example: TREX_DEBUG_GC=1 RUST_LOG=debug ./target/debug/trex start ..."

clean: clean_build clean_rust
clean_all: clean_configure clean
