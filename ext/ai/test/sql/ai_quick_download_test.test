# name: test/sql/ai_quick_download_test.test
# description: Quick test using a very small downloadable model for CI/testing
# group: [sql]

require ai

# Test with a minimal downloadable model (GPT-2 style, very small)
# Using a tiny quantized model for faster download in CI environment

# Test 1: Quick download and load
statement ok
SELECT trex_ai_download_model('https://huggingface.co/aladar/TinyLLama-v0-GGUF/resolve/main/TinyLLama-v0.Q8_0.gguf', 'tiny-test-model.gguf');

# Verify download completed
query I  
SELECT trex_ai_list_models() LIKE '%tiny-test-model%';
----
true

# Test 2: Load model for generation
statement ok
SELECT trex_ai_load_model('/home/ph/.local/share/duckdb-llama/models/tiny-test-model.gguf', '{"n_ctx": 512, "n_gpu_layers": 0, "num_threads": 1}');

# Test 3: Quick generation test
query I
SELECT LENGTH(trex_ai_generate('tiny-test-model', 'Hi', '{"max_tokens": 2}')) > 0;
----
true

# Test 4: Embeddings test
statement ok  
SELECT trex_ai_load_model_for_embeddings('tiny-test-model', '{"n_ctx": 512}');

query I
SELECT trex_ai_embed('tiny-test-model', 'test') LIKE '%[%' OR LENGTH(trex_ai_embed('tiny-test-model', 'test')) > 10;
----
true

# Test 5: Chat format test
query I
SELECT LENGTH(trex_ai_chat('tiny-test-model', '[{"role":"user","content":"Hi"}]', '{"max_tokens":2}')) > 0;
----
true

# Test 6: All status functions work with loaded model
query I
SELECT trex_ai_gpu_info() LIKE '%gpu_support%' AND 
       trex_ai_status() LIKE '%Extension Status%' AND
       trex_ai_model_info('tiny-test-model') LIKE '%Model Information%' AND
       trex_ai_list_loaded() LIKE '%tiny-test-model%';
----
true

# Cleanup
statement ok
SELECT trex_ai_unload_model('tiny-test-model');

statement ok
SELECT 'All quick tests passed';
