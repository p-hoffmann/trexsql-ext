# name: test/sql/ai_model_dependent.test  
# description: Tests for LLaMA extension functions that require actual models
# group: [sql]
# require: llama

# This test file contains tests that require actual model files to be present
# These tests are designed to run in environments where test models are available

require ai

# Skip this test if LLAMA_TEST_MODEL_PATH environment variable is not set
require-env LLAMA_TEST_MODEL_PATH

# Test Model Loading and Basic Operations
statement ok
SELECT trex_ai_load_model($LLAMA_TEST_MODEL_PATH, '{"context_size": 512, "gpu_layers": 0}') AS load_result;

# Verify model was loaded successfully
query I
SELECT trex_ai_list_loaded() LIKE '%"models":%' AND trex_ai_list_loaded() NOT LIKE '%"models":[]%';
----
true

# Test Model Information
statement ok
SELECT trex_ai_model_info('default') AS model_info;

# Test Text Generation with Minimal Settings
query I
SELECT LENGTH(trex_ai_generate('default', 'Hello', '{"max_tokens": 5, "temperature": 0.0}')) > 0;
----
true

# Test Chat Functionality
query I
SELECT LENGTH(trex_ai_chat('default', '[{"role": "user", "content": "Hi"}]', '{"max_tokens": 5, "temperature": 0.0}')) > 0;
----
true

# Test Embeddings (if model supports it)
statement ok
SELECT trex_ai_load_model_for_embeddings($LLAMA_TEST_MODEL_PATH, '{"context_size": 256}') AS embed_load_result;

# Test embedding generation
query I
SELECT LENGTH(trex_ai_embed('default', 'test text')) > 0;
----
true

# Test Streaming Functions
query I
SELECT COUNT(*) > 0 FROM trex_ai_stream_generate('default', 'Hello', options := '{"max_tokens": 3}');
----
true

query I
SELECT COUNT(*) > 0 FROM trex_ai_stream_chat('default', '[{"role": "user", "content": "Hi"}]', options := '{"max_tokens": 3}');
----
true

# Test Batch Processing
query I
SELECT trex_ai_batch_process('{"requests": [{"model": "default", "prompt": "Hi", "max_tokens": 3}]}') LIKE '%"success"%';
----
true

# Test Model Status After Loading
query I
SELECT trex_ai_status() LIKE '%"total_loaded": 1%' OR trex_ai_status() LIKE '%"total_loaded":1%';
----
true

# Clean up - Unload model
statement ok
SELECT trex_ai_unload_model('default');

# Verify model was unloaded
query I
SELECT trex_ai_list_loaded() LIKE '%"models":[]%';
----
true
