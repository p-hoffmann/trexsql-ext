# name: test/sql/swarm.test
# description: test swarm extension cluster basics
# group: [swarm]

# Before we load the extension, this will fail
statement error
SELECT swarm_start('127.0.0.1', 7946, 'test-cluster');
----
Catalog Error: Scalar Function with name swarm_start does not exist!

# Require statement will ensure the extension is loaded from now on
require swarm

# Confirm swarm_nodes returns empty when gossip is not running
query IIIII
SELECT * FROM swarm_nodes();
----

# Confirm swarm_config returns empty when gossip is not running
query II
SELECT * FROM swarm_config();
----

# Start gossip on this node
query I
SELECT swarm_start('127.0.0.1', 17946, 'test-cluster');
----
Swarm started on 127.0.0.1:17946 (cluster: test-cluster)

# Verify swarm_nodes shows this node
query IIIII
SELECT node_name, gossip_addr, data_node, status FROM swarm_nodes();
----
node-127.0.0.1:17946	127.0.0.1:17946	true	active

# Verify swarm_config shows configuration
query II
SELECT key, value FROM swarm_config() WHERE key = 'cluster_id';
----
cluster_id	test-cluster

# Test swarm_set
query I
SELECT swarm_set('data_node', 'false');
----
Set data_node = false (propagating to cluster)

# Verify the set took effect
query II
SELECT key, value FROM swarm_config() WHERE key = 'data_node';
----
data_node	false

# Stop gossip
query I
SELECT swarm_stop();
----
Swarm stopped
