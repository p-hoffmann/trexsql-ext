# name: test/sql/tpm_functions.test
# description: test tpm functions in tpm extension
# group: [tpm]

# Require the extension
require tpm

# Test tpm_info with a real package
query I
SELECT
  json_extract_string(package_info, '$.name') as name
FROM tpm_info('is-number');
----
is-number

# Test tpm_info returns correct fields
query I
SELECT
  json_extract_string(package_info, '$.latest_version') IS NOT NULL as has_latest
FROM tpm_info('lodash');
----
true

# Test tpm_info error handling for non-existent package
query I
SELECT
  json_extract_string(package_info, '$.error') LIKE 'Package not found%' as is_error
FROM tpm_info('this-package-does-not-exist-xyz123');
----
true

# Test tpm_info returns version list
query I
SELECT
  json_array_length(json_extract(package_info, '$.versions')) > 0 as has_versions
FROM tpm_info('is-number');
----
true

# Test tpm_resolve with exact version
query I
SELECT
  json_extract_string(resolve_info, '$.resolved_version') as version
FROM tpm_resolve('is-number@7.0.0');
----
7.0.0

# Test tpm_resolve with latest
query I
SELECT
  json_extract_string(resolve_info, '$.package') as package
FROM tpm_resolve('lodash');
----
lodash

# Test tpm_resolve returns tarball URL
query I
SELECT
  json_extract_string(resolve_info, '$.tarball_url') LIKE 'https://registry.npmjs.org/%' as has_tarball
FROM tpm_resolve('is-number');
----
true

# Test semver resolution with caret range
query I
SELECT
  json_extract_string(resolve_info, '$.resolved_version') as version
FROM tpm_resolve('is-number@^7.0.0');
----
7.0.0

# Test semver resolution with tilde range
query I
SELECT
  json_extract_string(resolve_info, '$.package') as package
FROM tpm_resolve('chalk@~4.1.0');
----
chalk

# Test shasum is included in resolve response
query I
SELECT
  json_extract_string(resolve_info, '$.shasum') IS NOT NULL as has_shasum
FROM tpm_resolve('is-number@7.0.0');
----
true

# Test scoped packages
query I
SELECT
  json_extract_string(package_info, '$.name') as name
FROM tpm_info('@types/node');
----
@types/node

# Test dependency tree visualization
query I
SELECT
  json_extract_string(tree_info, '$.package') as package
FROM tpm_tree('is-number@7.0.0')
LIMIT 1;
----
is-number

# Test tree_line formatting
query I
SELECT
  json_extract_string(tree_info, '$.tree_line') LIKE '%is-number%' as has_package_in_tree
FROM tpm_tree('is-number@7.0.0')
LIMIT 1;
----
true
