# name: test/sql/llama_all_functions.test
# description: Comprehensive tests for all LLaMA extension SQL functions
# group: [sql]

# Require the extension
require llama

# Test 1: Legacy test functions
query I
SELECT llama('TestUser');
----
Llama TestUser ðŸ¦™

query I
SELECT llama_openssl_version('TestUser') ILIKE 'Llama TestUser, my linked OpenSSL version is OpenSSL%';
----
true

# Test 2: Status Functions (no model dependencies)

# Test llama_status - should work without models loaded
query I
SELECT llama_status() LIKE '%Extension Status%';
----
true

# Test llama_gpu_info - should show GPU information
query I
SELECT llama_gpu_info() LIKE '%"gpu_support":%';
----
true

# Test 3: Model Management Functions

# Test llama_list_models - should work without models (returns empty or error gracefully)
statement ok
SELECT llama_list_models();

# Test llama_list_loaded - should return empty list initially
query I
SELECT llama_list_loaded() LIKE '%Currently Loaded Models%';
----
true

# Test 4: Basic Function Availability Tests

# Test that functions exist and return something
query I
SELECT llama_status() IS NOT NULL;
----
true

# Test that list functions work
query I
SELECT llama_list_models() IS NOT NULL;
----
true

# Test that info functions work
query I
SELECT llama_gpu_info() IS NOT NULL;
----
true

# Test 5: Download Functions

# Test llama_download_model - should handle invalid URLs gracefully
query I
SELECT llama_download_model('invalid://test-url', 'test') IS NOT NULL;
----
true

# Test 6: Extension Status and Info Functions

# Test extension status
query I
SELECT LENGTH(llama_status()) > 10;
----
true

# Test GPU info
query I
SELECT LENGTH(llama_gpu_info()) > 5;
----
true

# Test list models when empty
query I
SELECT llama_list_models() LIKE '%Models%' OR llama_list_models() LIKE '%models%';
----
true

# Test 7: Final validation - all functions exist
query I
SELECT 1;
----
1


# Test invalid JSON in config parameters

query I
SELECT llama_generate('model', 'prompt', 'invalid_json') LIKE '%Error%' OR llama_generate('model', 'prompt', 'invalid_json') LIKE '%error%';
----
true

query I
SELECT llama_chat('model', 'invalid_json') LIKE '%Error%' OR llama_chat('model', 'invalid_json') LIKE '%error%';
----
true

query I
SELECT llama_chat('model', '[{"role": "user"}]', 'invalid_json') LIKE '%Error%' OR llama_chat('model', '[{"role": "user"}]', 'invalid_json') LIKE '%error%';
----
true

# Test 11: Edge Cases

# Test empty string parameters

query I
SELECT llama_generate('', 'prompt') LIKE '%Error%' OR llama_generate('', 'prompt') LIKE '%error%';
----
true

query I
SELECT llama_generate('model', '') LIKE '%Error%' OR llama_generate('model', '') LIKE '%error%';
----
true


# Test very long strings (should handle gracefully)
query I
SELECT LENGTH(llama('A very long name that is much longer than typical user names and contains many characters to test string handling')) > 50;
----
true

# Test 12: Function Return Type Validation

# Verify return types are correct
query I
SELECT typeof(llama_status());
----
VARCHAR

query I  
SELECT typeof(llama_gpu_info());
----
VARCHAR

query I
SELECT typeof(llama_list_loaded());
----
VARCHAR

query I
SELECT typeof(llama_list_models());
----
VARCHAR

# Test 13: Concurrent Access (basic)

# Test multiple calls to status functions
query I
SELECT llama_status() IS NOT NULL AND llama_gpu_info() IS NOT NULL AND llama_list_loaded() IS NOT NULL;
----
true

# Test 14: Memory and Resource Management

# Test rapid successive calls to ensure no memory leaks
statement ok
SELECT llama_status() FROM range(10);

statement ok  
SELECT llama_gpu_info() FROM range(10);

statement ok
SELECT llama_list_loaded() FROM range(5);

# Test 15: Integration with DuckDB Features

# Test using functions in WHERE clauses
query I
SELECT COUNT(*) FROM (SELECT 1) WHERE llama_status() IS NOT NULL;
----
1

# Test using functions in subqueries
query I
SELECT (SELECT llama_gpu_info()) IS NOT NULL;
----
true

# Test using functions with CASE statements
query I
SELECT CASE WHEN llama_status() IS NOT NULL THEN 'Extension Working' ELSE 'Extension Failed' END;
----
Extension Working

# Test 16: Complex JSON Parameter Structures

# Test complex configuration JSON (should parse without errors in validation)

# Test complex generation options JSON
query I
SELECT llama_generate('model', 'prompt', '{"max_tokens": 100, "temperature": 0.8, "top_p": 0.9, "top_k": 40, "repeat_penalty": 1.1, "stream": false}') LIKE '%Error%' OR llama_generate('model', 'prompt', '{"max_tokens": 100, "temperature": 0.8, "top_p": 0.9, "top_k": 40, "repeat_penalty": 1.1, "stream": false}') LIKE '%error%';
----
true

# Test complex chat message structure
query I
SELECT llama_chat('model', '[{"role": "system", "content": "You are helpful"}, {"role": "user", "content": "Hello"}, {"role": "assistant", "content": "Hi there!"}]') LIKE '%Error%' OR llama_chat('model', '[{"role": "system", "content": "You are helpful"}, {"role": "user", "content": "Hello"}, {"role": "assistant", "content": "Hi there!"}]') LIKE '%error%';
----
true

# Test 17: Function Name Case Sensitivity

# Test that function names are case insensitive (DuckDB standard)
query I
SELECT LLAMA_STATUS() IS NOT NULL;
----
true

# query I
# SELECT Llama_Gpu_Info() IS NOT NULL;  
# ----
# true

# Test 18: Performance and Limits

# Test with maximum length strings (within reason)
statement ok
SELECT llama(repeat('x', 1000));

# Test 19: Extension Information

# Verify extension is properly loaded and functions are available
query I
SELECT COUNT(*) > 10 FROM duckdb_functions() WHERE function_name LIKE 'llama_%';
----
true

# Test 20: Error Message Quality

# Verify error messages are informative (where possible)
# query I
# SELECT llama_load_model('/this/path/definitely/does/not/exist.gguf') LIKE '%Error%' OR llama_load_model('/this/path/definitely/does/not/exist.gguf') LIKE '%error%';
# ----
# true
