#!/usr/bin/env nbb
(ns bao.core
  (:require ["duckdb$default" :as duckdb]
            ["fs" :as fs]
            ["path" :as path]
            ["minimist$default" :as minimist]
            [promesa.core :as p]
            [clojure.string]))

(defn query
  [conn sql]
  (js/Promise.
    (fn [resolve reject]
      (.all conn sql
        (fn [err rows]
          (if err
            (reject err)
            (resolve (js->clj rows :keywordize-keys true))))))))

(defn execute
  ([conn sql]
   (js/Promise.
     (fn [resolve reject]
       (.run conn sql
         (fn [err]
           (if err
             (reject err)
             (resolve true)))))))
  ([conn sql params]
   (js/Promise.
     (fn [resolve reject]
       (.run conn sql (clj->js params)
         (fn [err]
           (if err
             (reject err)
             (resolve true))))))))

(defn has-avx-support?
  []
  (try
    (let [os (js/require "os")]
      (when (or (= (.-arch os) "x64") (= (.arch os) "x64"))
        (try
          (let [cpuinfo (fs/readFileSync "/proc/cpuinfo" "utf8")]
            (boolean (re-find #"\bavx\b" cpuinfo)))
          (catch :default e
            false))))
    (catch :default e
      false)))

(defn load-trex-extensions
  [conn]
  (p/let [trex-path (path/join "node_modules" "@trex")
          entries (js/Promise.resolve
                    (try
                      (fs/readdirSync trex-path #js {:withFileTypes true})
                      (catch :default e
                        (js/console.warn "Could not read @trex directory:" (.-message e))
                        #js [])))]
    (p/all
      (for [entry (js->clj entries)
            :when (.-isDirectory entry)
            :let [dir-name (.-name entry)
                  dir-path (path/join trex-path dir-name)
                  ext-files (try
                              (js->clj (fs/readdirSync dir-path))
                              (catch :default e []))
                  ext-file (first (filter #(re-find #"\.duckdb_extension$" %) ext-files))
                  ext-path (when ext-file (path/join dir-path ext-file))
                  ext-name (when ext-file (clojure.string/replace ext-file #"\.duckdb_extension$" ""))
                  skip-extension? (and (= ext-name "llama") (not (has-avx-support?)))]
            :when (and ext-path (not skip-extension?))]
        (p/do!
          (js/console.log (str "Loading extension: " ext-name))
          (execute conn (str "LOAD '" ext-path "'")))))))


;; Execute immediately when loaded
(println "ðŸ¦• Starting TREX")

(let [cwd (js/process.cwd)
      ;; When run directly, args start from index 2 (after node and script path)
      argv-array (.-argv js/process)
      args-to-parse (.slice argv-array 2)
      args (minimist args-to-parse #js {:string ["trexas-host" "pgwire-host" "main-path" "event-worker-path" 
                                                   "inspector-type" "inspector-host" "tls-cert" "tls-key"]
                                         :number ["trexas-port" "tls-port" "pgwire-port" "inspector-port"]
                                         :boolean ["enable-inspector" "allow-main-inspector"]
                                         :default #js {:trexas-host "0.0.0.0"
                                                      :trexas-port 9876
                                                      :tls-port 9443
                                                      :pgwire-host "0.0.0.0"
                                                      :pgwire-port 5433
                                                      :enable-inspector false
                                                      :allow-main-inspector false
                                                      :inspector-type "inspect"
                                                      :inspector-host "0.0.0.0"
                                                      :inspector-port 9229
                                                      :main-path (path/join cwd "main")}
                                         :alias #js {:h "help"}})
        args-map (js->clj args :keywordize-keys true)]
    
    ;; Show help if requested
    (when (:help args-map)
      (println "
Usage: bao [options]

Options:
  --trexas-host <host>        Trexas server host (default: 0.0.0.0)
  --trexas-port <port>        Trexas server port (default: 9876)
  --pgwire-host <host>        PgWire server host (default: 0.0.0.0)
  --pgwire-port <port>        PgWire server port (default: 5433)
  --enable-inspector          Enable Trexas inspector
  --inspector-type <type>     Inspector type: inspect, inspect-brk, inspect-wait (default: inspect)
  --inspector-host <host>     Inspector host (default: 0.0.0.0)
  --inspector-port <port>     Inspector port (default: 9229)
  --allow-main-inspector      Allow inspector in main worker (default: false)
  --tls-cert <path>           Path to TLS certificate file (enables HTTPS)
  --tls-key <path>            Path to TLS private key file (required with --tls-cert)
  --tls-port <port>           TLS port (default: 9443)
  --main-path <path>          Path to main service directory (default: ./main)
  --event-worker-path <path>  Path to event worker directory
  -h, --help                  Show this help message
")
      (js/process.exit 0))
    
    (let [trexas-host (:trexas-host args-map)
          trexas-port (:trexas-port args-map)
          pgwire-host (:pgwire-host args-map)
          pgwire-port (:pgwire-port args-map)
          enable-inspector (:enable-inspector args-map)
          inspector-type (:inspector-type args-map)
          inspector-host (:inspector-host args-map)
          inspector-port (:inspector-port args-map)
          allow-main-inspector (:allow-main-inspector args-map)
          tls-cert (:tls-cert args-map)
          tls-key (:tls-key args-map)
          tls-port (:tls-port args-map)
          main-path (:main-path args-map)
          event-worker-path (:event-worker-path args-map)
          
          db (new (.-Database duckdb) ":memory:" #js {:allow_unsigned_extensions "true"})
          conn (.connect db)
          
          ;; Build inspector string if enabled
          inspector-config (when enable-inspector
                            (str inspector-type ":" inspector-host ":" inspector-port))
          
          ;; Build trexas config
          trexas-config-map (cond-> {:host trexas-host
                                     :port trexas-port
                                     :main_service_path main-path}
                              inspector-config (assoc :inspector inspector-config)
                              allow-main-inspector (assoc :allow_main_inspector true)
                              tls-cert (assoc :tls_cert_path tls-cert)
                              tls-key (assoc :tls_key_path tls-key)
                              tls-port (assoc :tls_port tls-port)
                              event-worker-path (assoc :event_worker_path event-worker-path))
          trexas-config (js/JSON.stringify (clj->js trexas-config-map))]
      (-> (p/do!
            (load-trex-extensions conn)
            (println "\nðŸš€ Starting servers...")
            ;; Start pgwire server
            (p/let [pgwire-password (.-TREX_SQL_PASSWORD (.-env js/process))]
              (when-not pgwire-password
                (js/console.error "Error: TREX_SQL_PASSWORD environment variable is not set")
                (js/process.exit 1))
              (p/let [pgwire-result (query conn (str "SELECT start_pgwire_server('" pgwire-host "', " pgwire-port ", '" pgwire-password "', '') as result"))]
                (println "PgWire server:" (get-in pgwire-result [0 :result]))
                (when (re-find #"Error|error" (get-in pgwire-result [0 :result] ""))
                  (throw (js/Error. (str "Failed to start pgwire server: " (get-in pgwire-result [0 :result])))))))
            ;; Start trexas server with config
            (p/let [trexas-result (query conn (str "SELECT trex_start_server_with_config('" trexas-config "') as result"))]
              (println "Trexas server:" (get-in trexas-result [0 :result]))
              (when (re-find #"Error|Failed" (get-in trexas-result [0 :result] ""))
                (throw (js/Error. (str "Failed to start trexas server: " (get-in trexas-result [0 :result]))))))
            (println "\nâœ… Servers started successfully")
            (println (str "Trexas listening on " 
                         (if tls-cert "https://" "http://") 
                         trexas-host ":" trexas-port 
                         (when inspector-config (str " (inspector: " inspector-config ")"))
                         (when event-worker-path " (with event worker)")
                         (when-not event-worker-path " (without event worker)")))
            (println (str "PgWire listening on " pgwire-host ":" pgwire-port))
            (println "\nPress Ctrl+C to stop")
            
            ;; Set up signal handlers for graceful shutdown
            (js/process.on "SIGINT" #(do
                                       (println "\n\nShutting down...")
                                       (.close conn)
                                       (.close db)
                                       (js/process.exit 0)))
            (js/process.on "SIGTERM" #(do
                                        (println "\n\nShutting down...")
                                        (.close conn)
                                        (.close db)
                                        (js/process.exit 0)))
            
            ;; Keep process alive - run every hour
            (js/setInterval (fn [] nil) 3600000)
            nil)
          (p/catch (fn [err]
                     (js/console.error "Error:" err)
                     (.close conn)
                     (.close db)
                     (js/process.exit 1))))))
