name: d2e build plugin

on:
  workflow_dispatch:
    inputs:
      GIT_REPO_FULL_NAME:
        description: Select RepoName
        required: false
        type: choice
        options:
          - OHDSI/trexsql-ext
      GIT_BRANCH_NAME:
        default: develop
        description: Enter BranchName / ReleaseTagName
        required: true
        type: string
      tag:
        description: Enter tag for release
        required: true
        type: string
      release:
        description: Enter name for github release
        required: true
        type: string
      prerelease:
        type: boolean
        default: true
        required: true
      overwrite:
        type: boolean
        default: true
        required: true
      artifacttype:
        type: choice
        required: true
        default: "OSS-develop"
        options:
          - "OSS-develop"
          - "OSS-release"
          - "Project"
  pull_request:
    types: [opened, ready_for_review, reopened, synchronize]
  merge_group:
  push:
    branches:
      - develop
      - main

env:
  GIT_BRANCH_NAME: ${{ github.event.inputs.GIT_BRANCH_NAME || github.head_ref || github.ref_name }} # workflow_dispatch || pull_request || push
  GIT_REPO_FULL_NAME: ${{ github.event.inputs.GIT_REPO_FULL_NAME || github.event.pull_request.head.repo.full_name || github.event.repository.full_name }} # workflow_dispatch || pull_request || push
  NPM_ARTIFACT_TYPE: ${{ github.event.inputs.artifacttype || 'OSS-develop'}}

jobs:

  pick_runner:
    runs-on: ubuntu-latest
    if: (github.ref_name == 'develop' || github.ref_name == 'main' || contains('release/', github.ref_name) || github.event_name == 'workflow_dispatch') || ( github.event_name == 'pull_request' && !github.event.pull_request.draft ) # Should run if branch is develop/main/release/workflow_dispatch and doesnt have a PR
    outputs:
      random_runner: ${{ steps.shuffle.outputs.random_runner }}
    steps:
      - id: shuffle
        run: echo "random_runner=$(shuf -e ubuntu-22.04 ubuntu-24.04 | head -n 1)" >> "$GITHUB_OUTPUT"

  build:
    needs: [pick_runner]
    if: (github.ref_name == 'develop' || github.ref_name == 'main' || contains('release', github.ref_name) || github.event_name == 'workflow_dispatch') || ( github.event_name == 'pull_request' && !github.event.pull_request.draft  ) # Should run if branch is develop/main/release/workflow_dispatch and doesnt have a PR

    strategy:
      fail-fast: false
      matrix:
        include:
          - PKGPATH: ./ext/chdb
            RUNNER: ubuntu-24.04
          - PKGPATH: ./ext/circe
            RUNNER: ubuntu-24.04
          - PKGPATH: ./ext/hana
          - PKGPATH: ./ext/llama
            RUNNER: ubuntu-24.04
          - PKGPATH: ./ext/pgwire
          - PKGPATH: ./ext/tpm
          - PKGPATH: ./ext/migration
          - PKGPATH: ./ext/swarm
          - PKGPATH: ./ext/etl
          - PKGPATH: ./ext/bao

    runs-on: ${{ matrix.RUNNER || needs.pick_runner.outputs.random_runner }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_BRANCH_NAME }}
          repository: ${{ env.GIT_REPO_FULL_NAME }}
          submodules: recursive
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18.x"
          registry-url: "https://npm.pkg.github.com"
          scope: "@trex"
      - name: Setup NPM
        if: ${{ matrix.NPM }}
        run: npm install -g ${{ matrix.NPM }}
      - name: Install dependencies
        if: ${{ matrix.DESTPATH }}
        run: |
          npm install -g deno@2.1.13
          node ./install-deno-deps.js ${{ matrix.PKGPATH }}
      - name: Update version
        run: |
          cd ${{ matrix.PKGPATH }}
          if [[ $GITHUB_EVENT_NAME == 'workflow_dispatch' ]]; then
            RELEASE_VERSION=${{ github.event.inputs.tag }}
            jq --arg v $RELEASE_VERSION '.version=$v' package.json > tmppkg; mv tmppkg package.json
          else
            jq --arg v "-$(date +%s)-$GITHUB_SHA" '.version+=$v' package.json > tmppkg; mv tmppkg package.json
          fi
      - name: Set up Java 17
        if: matrix.PKGPATH == './ext/bao'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - name: Install Leiningen
        if: matrix.PKGPATH == './ext/bao'
        run: |
          sudo curl -sL https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein -o /usr/local/bin/lein
          sudo chmod +x /usr/local/bin/lein
          lein version
      - name: Install dependencies
        run: |
          cd ${{ matrix.PKGPATH }}
          ${{ matrix.NPM == 'yarn' && 'yarn install' ||'npm install --ignore-scripts' }}
        env:
          CI: ${{ matrix.NPM != 'yarn' }}
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Patch Package
        if: ${{ matrix.NPM }}
        working-directory: ${{ matrix.PKGPATH }}
        run: jq '.private=false' package.json > tmppkg; mv tmppkg package.json
      - name: DEST
        working-directory: ${{ matrix.PKGPATH }}
        if: ${{ matrix.DESTPATH }}
        run: |
          cp package.json package.org.json
          sudo mkdir -p ${{ matrix.DESTPATH }}
          sudo chown runner:docker ${{ matrix.DESTPATH }}
          cp -a . ${{ matrix.DESTPATH }}
          cd ${{ matrix.DESTPATH }}
          export TREX_DOCKER_TAG=sha256:468f1fa411b288f8ebac842dc0982bb7b8cb2d5eeb8dc25a494b734fcacfac42
          echo "Using TREX_DOCKER_TAG=$TREX_DOCKER_TAG"
          npm run build
      - name: Use Node.js - OSS Develop
        uses: actions/setup-node@v4
        if: env.NPM_ARTIFACT_TYPE == 'OSS-develop'
        with:
          node-version: "18.x"
          registry-url: "https://pkgs.dev.azure.com/data2evidence/d2e/_packaging/d2e/npm/registry/"
          scope: "@trex"
      - name: Use Node.js - OSS Release
        uses: actions/setup-node@v4
        if: env.NPM_ARTIFACT_TYPE == 'OSS-release'
        with:
          node-version: "18.x"
          registry-url: "https://pkgs.dev.azure.com/data2evidence/d2e/_packaging/stable/npm/registry/"
          scope: "@trex"
      - name: Use Node.js - Project
        uses: actions/setup-node@v4
        if: env.NPM_ARTIFACT_TYPE == 'Project'
        with:
          node-version: "18.x"
          registry-url: "https://pkgs.dev.azure.com/data2evidence/d2e/_packaging/ms/npm/registry/"
          scope: "@trex"
      - name: Publish
        env:
          CI: ${{ matrix.NPM != 'yarn' }}
          SHOULD_PUBLISH: ${{ github.ref_name == 'develop' || github.ref_name == 'main' || github.event_name == 'workflow_dispatch' }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_PROJECT_TOKEN }}
          DUCKDB_EXTENSION_SIGNING_KEY: ${{ secrets.DUCKDB_EXTENSION_SIGNING_KEY }}
        run: |
          cd ${{ matrix.DESTPATH || matrix.PKGPATH }}
          if [[ $SHOULD_PUBLISH == true ]]; then
             ${{ matrix.NPM || 'npm' }} publish
          else
             ${{ matrix.NPM || 'npm' }} pack
          fi
      - name: Extract extension name
        id: extname
        run: echo "name=$(basename ${{ matrix.PKGPATH }})" >> "$GITHUB_OUTPUT"
      - name: Upload extension artifact
        if: hashFiles(format('{0}/*.trex', matrix.PKGPATH)) != ''
        uses: actions/upload-artifact@v4
        with:
          name: ext-${{ steps.extname.outputs.name }}
          path: ${{ matrix.PKGPATH }}/*.trex
          retention-days: 1

  create-release:
    needs: [build]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.tag != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_BRANCH_NAME }}
          repository: ${{ env.GIT_REPO_FULL_NAME }}
      - name: Download all extension artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ext-*
          path: release-assets/
          merge-multiple: true
      - name: List release assets
        run: ls -la release-assets/
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.release }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: release-assets/*.trex
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-docker:
    needs: [build]
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_BRANCH_NAME }}
          repository: ${{ env.GIT_REPO_FULL_NAME }}
      - name: Download extension artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ext-*
          path: extensions/
          merge-multiple: true
      - name: List extensions
        run: ls -la extensions/
      - name: Build Docker image
        run: docker build -t trexsql-test .
      - name: Test extensions load
        run: |
          OUTPUT=$(docker run --rm trexsql-test --check 2>&1) || true
          echo "$OUTPUT"
          echo "$OUTPUT" | grep -q "extension(s) loaded successfully"
      - name: Login to GHCR
        if: github.ref_name == 'develop' || github.ref_name == 'main' || github.event_name == 'workflow_dispatch'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Push to GHCR
        if: github.ref_name == 'develop' || github.ref_name == 'main' || github.event_name == 'workflow_dispatch'
        run: |
          docker tag trexsql-test ghcr.io/p-hoffmann/trexsql:latest
          docker tag trexsql-test ghcr.io/p-hoffmann/trexsql:sha-${{ github.sha }}
          docker push ghcr.io/p-hoffmann/trexsql:latest
          docker push ghcr.io/p-hoffmann/trexsql:sha-${{ github.sha }}

  build-pg-trex:
    needs: [build]
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_BRANCH_NAME }}
          repository: ${{ env.GIT_REPO_FULL_NAME }}
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - name: Install PostgreSQL 17 dev headers
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
          sudo apt-get update
          sudo apt-get install -y postgresql-17 postgresql-server-dev-17

      - name: Download libtrexsql
        run: |
          wget -O /tmp/libtrexsql.zip \
            https://github.com/p-hoffmann/trexsql-rs/releases/download/v1.4.0-trex/libtrexsql-linux-amd64.zip
          unzip /tmp/libtrexsql.zip -d /tmp/trexsql

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.pgrx
            ext/pg_trex/target
          key: rust-pg-trex-${{ runner.os }}-${{ hashFiles('ext/pg_trex/Cargo.lock') }}
          restore-keys: rust-pg-trex-${{ runner.os }}-

      - name: Install cargo-pgrx and init
        run: |
          cargo install cargo-pgrx --version 0.16.1 --locked
          cargo pgrx init --pg17=$(which pg_config)

      - name: Build pg_trex
        run: LIBRARY_PATH=/tmp/trexsql cargo build
        working-directory: ext/pg_trex

      - name: Download extension artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ext-*
          path: ext/pg_trex/extensions/
          merge-multiple: true

      - name: List extensions
        run: ls -la ext/pg_trex/extensions/

      - name: Build pg_trex Docker image
        run: docker build -t pg-trex-test .
        working-directory: ext/pg_trex

      - name: Smoke test
        run: |
          docker run -d --name pg-trex-smoke \
            pg-trex-test \
            postgres \
            -c shared_preload_libraries=pg_trex \
            -c pg_trex.swarm_extension_path=/usr/lib/trexsql/extensions/swarm.trex
          sleep 8
          docker exec pg-trex-smoke pg_isready -U postgres
          docker exec pg-trex-smoke psql -U postgres -c "SELECT state FROM pg_trex_status()"
          docker rm -f pg-trex-smoke

      - name: Login to GHCR
        if: github.ref_name == 'develop' || github.ref_name == 'main' || github.event_name == 'workflow_dispatch'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to GHCR
        if: github.ref_name == 'develop' || github.ref_name == 'main' || github.event_name == 'workflow_dispatch'
        run: |
          docker tag pg-trex-test ghcr.io/p-hoffmann/pg-trex:latest
          docker tag pg-trex-test ghcr.io/p-hoffmann/pg-trex:sha-${{ github.sha }}
          docker push ghcr.io/p-hoffmann/pg-trex:latest
          docker push ghcr.io/p-hoffmann/pg-trex:sha-${{ github.sha }}

  success:
    needs: [build, build-docker, build-pg-trex, create-release]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check
        run: |
          if [[ "${{ needs.build.result }}" == "failure" || "${{ needs.build-docker.result }}" == "failure" || "${{ needs.build-pg-trex.result }}" == "failure" || "${{ needs.create-release.result }}" == "failure" ]]; then
            echo "::error::One or more jobs failed"
            exit 1
          fi
          echo "All required jobs passed (or were skipped)"
