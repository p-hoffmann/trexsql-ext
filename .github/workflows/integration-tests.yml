name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, ready_for_review, reopened, synchronize]
    branches: [main, develop]
  merge_group:
  workflow_dispatch:

concurrency:
  group: integration-tests-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # ===========================================================================
  # Layer 1: Build Jobs (all run in parallel)
  # ===========================================================================

  build-rust-core:
    name: "Build flight + swarm"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/flight/target
            ext/swarm/target
          key: rust-core-${{ runner.os }}-${{ hashFiles('ext/flight/Cargo.lock', 'ext/swarm/Cargo.lock') }}
          restore-keys: rust-core-${{ runner.os }}-

      - name: Build flight
        run: make configure && make debug
        working-directory: ext/flight

      - name: Build swarm
        run: make configure && make debug
        working-directory: ext/swarm

      - uses: actions/upload-artifact@v4
        with:
          name: ext-flight
          path: ext/flight/build/debug/extension/flight/flight.trex
          retention-days: 1

      - uses: actions/upload-artifact@v4
        with:
          name: ext-swarm
          path: ext/swarm/build/debug/extension/swarm/swarm.trex
          retention-days: 1

  build-pg-trex:
    name: "Build pg_trex"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - name: Install PostgreSQL 17 dev headers
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
          sudo apt-get update
          sudo apt-get install -y postgresql-server-dev-17

      - name: Download libtrexsql
        run: |
          wget -O /tmp/libtrexsql.zip \
            https://github.com/p-hoffmann/trexsql-rs/releases/download/v1.4.0-trex/libtrexsql-linux-amd64.zip
          unzip /tmp/libtrexsql.zip -d /tmp/trexsql

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/pg_trex/target
          key: rust-pg-trex-${{ runner.os }}-${{ hashFiles('ext/pg_trex/Cargo.lock') }}
          restore-keys: rust-pg-trex-${{ runner.os }}-

      - name: Build pg_trex
        run: LIBRARY_PATH=/tmp/trexsql cargo build
        working-directory: ext/pg_trex

      - uses: actions/upload-artifact@v4
        with:
          name: pg-trex-build
          path: |
            ext/pg_trex/target/debug/libpg_trex.so
            ext/pg_trex/target/debug/pg_trex-pg17/usr/share/postgresql/17/extension/pg_trex.control
          retention-days: 1

  build-pgwire:
    name: "Build pgwire"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/pgwire/target
          key: rust-pgwire-${{ runner.os }}-${{ hashFiles('ext/pgwire/Cargo.lock') }}
          restore-keys: rust-pgwire-${{ runner.os }}-

      - name: Build pgwire
        run: make configure && make debug
        working-directory: ext/pgwire

      - uses: actions/upload-artifact@v4
        with:
          name: ext-pgwire
          path: ext/pgwire/build/debug/extension/pgwire/pgwire.trex
          retention-days: 1

  build-chdb:
    name: "Build chdb"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - name: Install chdb native library
        run: sudo apt-get update && sudo apt-get install -y libc6-dev clang && sudo bash ./install_chdb.sh
        working-directory: ext/chdb

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/chdb/target
          key: rust-chdb-${{ runner.os }}-${{ hashFiles('ext/chdb/Cargo.lock') }}
          restore-keys: rust-chdb-${{ runner.os }}-

      - name: Build chdb
        run: make configure && make debug
        working-directory: ext/chdb

      - uses: actions/upload-artifact@v4
        with:
          name: ext-chdb
          path: ext/chdb/build/debug/extension/chdb/chdb.trex
          retention-days: 1

  build-hana:
    name: "Build hana"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/hana/target
          key: rust-hana-${{ runner.os }}-${{ hashFiles('ext/hana/Cargo.lock') }}
          restore-keys: rust-hana-${{ runner.os }}-

      - name: Build hana
        run: make configure && make debug
        working-directory: ext/hana

      - uses: actions/upload-artifact@v4
        with:
          name: ext-hana
          path: ext/hana/build/debug/extension/hana_scan/hana_scan.trex
          retention-days: 1

  build-tpm:
    name: "Build tpm"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/tpm/target
          key: rust-tpm-${{ runner.os }}-${{ hashFiles('ext/tpm/Cargo.lock') }}
          restore-keys: rust-tpm-${{ runner.os }}-

      - name: Build tpm
        run: make configure && make debug
        working-directory: ext/tpm

      - uses: actions/upload-artifact@v4
        with:
          name: ext-tpm
          path: ext/tpm/build/debug/extension/tpm/tpm.trex
          retention-days: 1

  build-circe:
    name: "Build circe"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: graalvm/setup-graalvm@v1
        with:
          java-version: "21"
          components: native-image
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install circe build dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake libssl-dev xxd maven

      - uses: actions/cache@v4
        with:
          path: |
            ext/circe/build
            ext/circe/circe-be/target
          key: circe-${{ runner.os }}-${{ hashFiles('ext/circe/CMakeLists.txt', 'ext/circe/extension_config.cmake', 'ext/circe/circe-be/pom.xml', 'ext/circe/graalvm-config/**') }}
          restore-keys: circe-${{ runner.os }}-

      - name: Build circe
        run: make configure && make release
        working-directory: ext/circe

      - uses: actions/upload-artifact@v4
        with:
          name: ext-circe
          path: ext/circe/build/release/extension/circe/circe.trex
          retention-days: 1

  build-llama:
    name: "Build llama"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install llama build dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake libssl-dev libvulkan1 libvulkan-dev vulkan-tools glslc libshaderc1 spirv-tools vulkan-validationlayers mesa-vulkan-drivers

      - uses: actions/cache@v4
        with:
          path: ext/llama/build
          key: llama-cmake-${{ runner.os }}-${{ hashFiles('ext/llama/CMakeLists.txt', 'ext/llama/llama.cpp/CMakeLists.txt') }}
          restore-keys: llama-cmake-${{ runner.os }}-

      - name: Build llama
        run: make configure && make debug
        working-directory: ext/llama

      - uses: actions/upload-artifact@v4
        with:
          name: ext-llama
          path: ext/llama/build/debug/extension/llama/llama.trex
          retention-days: 1

  # ===========================================================================
  # Layer 2: Test Jobs
  # ===========================================================================

  test-distributed:
    name: "Test distributed (tier1/2/3)"
    runs-on: ubuntu-24.04
    needs: [build-rust-core]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-flight
          path: ext/flight/build/debug/extension/flight/

      - uses: actions/download-artifact@v4
        with:
          name: ext-swarm
          path: ext/swarm/build/debug/extension/swarm/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run tier1 tests
        run: venv/bin/pytest -v test_tier1_single_node.py
        working-directory: integration-tests

      - name: Run tier2 tests
        run: venv/bin/pytest -v test_tier2_two_node.py
        working-directory: integration-tests

      - name: Run tier3 tests
        run: venv/bin/pytest -v test_tier3_aggregation.py
        working-directory: integration-tests

  test-pgwire:
    name: "Test pgwire"
    runs-on: ubuntu-24.04
    needs: [build-rust-core, build-pgwire]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-flight
          path: ext/flight/build/debug/extension/flight/

      - uses: actions/download-artifact@v4
        with:
          name: ext-swarm
          path: ext/swarm/build/debug/extension/swarm/

      - uses: actions/download-artifact@v4
        with:
          name: ext-pgwire
          path: ext/pgwire/build/debug/extension/pgwire/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run pgwire standalone tests
        run: venv/bin/pytest -v test_pgwire_standalone.py
        working-directory: integration-tests

      - name: Run pgwire swarm tests
        run: venv/bin/pytest -v test_pgwire_swarm.py
        working-directory: integration-tests

  test-circe:
    name: "Test circe"
    runs-on: ubuntu-24.04
    needs: [build-circe]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-circe
          path: ext/circe/build/release/extension/circe/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run circe standalone tests
        run: venv/bin/pytest -v test_circe_standalone.py
        working-directory: integration-tests

  test-llama:
    name: "Test llama"
    runs-on: ubuntu-24.04
    needs: [build-llama]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-llama
          path: ext/llama/build/debug/extension/llama/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run llama standalone tests
        run: venv/bin/pytest -v test_llama_standalone.py
        working-directory: integration-tests

  test-chdb:
    name: "Test chdb"
    runs-on: ubuntu-24.04
    needs: [build-rust-core, build-chdb]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install chdb native library
        run: sudo bash ./install_chdb.sh
        working-directory: ext/chdb

      - uses: actions/download-artifact@v4
        with:
          name: ext-flight
          path: ext/flight/build/debug/extension/flight/

      - uses: actions/download-artifact@v4
        with:
          name: ext-swarm
          path: ext/swarm/build/debug/extension/swarm/

      - uses: actions/download-artifact@v4
        with:
          name: ext-chdb
          path: ext/chdb/build/debug/extension/chdb/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run chdb standalone tests
        run: venv/bin/pytest -v test_chdb_standalone.py
        working-directory: integration-tests

      - name: Run chdb swarm tests
        run: venv/bin/pytest -v test_chdb_swarm.py
        working-directory: integration-tests

  test-tpm:
    name: "Test tpm"
    runs-on: ubuntu-24.04
    needs: [build-tpm]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-tpm
          path: ext/tpm/build/debug/extension/tpm/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run tpm standalone tests
        run: venv/bin/pytest -v test_tpm_standalone.py
        working-directory: integration-tests

  test-hana:
    name: "Test hana"
    runs-on: ubuntu-24.04
    needs: [build-hana]
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - name: Start HANA Express container
        run: docker compose -f integration-tests/docker-compose.hana.yml up -d

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-hana
          path: ext/hana/build/debug/extension/hana_scan/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Wait for HANA to be ready
        run: |
          echo "Waiting for HANA Express to be fully ready..."
          for i in $(seq 1 120); do
            if docker logs trex-hana 2>&1 | grep -q "Startup finished!"; then
              echo "HANA startup finished after ~$((i * 5))s"
              sleep 5  # extra grace period after startup message
              exit 0
            fi
            sleep 5
          done
          echo "Timeout waiting for HANA (10 min)"
          docker logs trex-hana 2>&1 | tail -20
          exit 1

      - name: Run hana standalone tests
        run: venv/bin/pytest -v test_hana_standalone.py
        working-directory: integration-tests
        env:
          HANA_TEST_URL: "hdbsqls://SYSTEM:Toor1234@localhost:39041/HDB?insecure_omit_server_certificate_check"

      - name: Cleanup HANA container
        if: always()
        run: docker compose -f integration-tests/docker-compose.hana.yml down -v

  test-pg-trex:
    name: "Test pg_trex"
    runs-on: ubuntu-24.04
    needs: [build-rust-core, build-pg-trex]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: pg-trex-build
          path: ext/pg_trex/

      - uses: actions/download-artifact@v4
        with:
          name: ext-flight
          path: ext/pg_trex/extensions/

      - uses: actions/download-artifact@v4
        with:
          name: ext-swarm
          path: ext/pg_trex/extensions/

      - name: List pg_trex build context
        run: |
          ls -la ext/pg_trex/target/debug/libpg_trex.so
          ls -la ext/pg_trex/extensions/

      - name: Start pg_trex container
        run: docker compose -f integration-tests/docker-compose.pg_trex.yml up -d --build

      - name: Wait for pg_trex to be ready
        run: |
          for i in $(seq 1 30); do
            if docker exec trex-pg-trex pg_isready -U postgres 2>/dev/null; then
              echo "PostgreSQL ready after ~$((i * 2))s"
              sleep 5
              exit 0
            fi
            sleep 2
          done
          echo "Timeout waiting for PostgreSQL"
          docker logs trex-pg-trex 2>&1 | tail -30
          exit 1

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run pg_trex tests
        run: venv/bin/pytest -v test_pg_trex.py
        working-directory: integration-tests

      - name: Show pg_trex logs on failure
        if: failure()
        run: docker logs trex-pg-trex 2>&1 | tail -50

      - name: Cleanup
        if: always()
        run: docker compose -f integration-tests/docker-compose.pg_trex.yml down -v

  # ===========================================================================
  # Layer 3: Status Gate
  # ===========================================================================

  integration-tests-status:
    name: "Integration Tests Status"
    if: always()
    runs-on: ubuntu-24.04
    needs:
      - test-distributed
      - test-pgwire
      - test-circe
      - test-llama
      - test-chdb
      - test-tpm
      - test-hana
      - test-pg-trex
    steps:
      - name: Check test results
        run: |
          echo "test-distributed: ${{ needs.test-distributed.result }}"
          echo "test-pgwire:      ${{ needs.test-pgwire.result }}"
          echo "test-circe:       ${{ needs.test-circe.result }}"
          echo "test-llama:       ${{ needs.test-llama.result }}"
          echo "test-chdb:        ${{ needs.test-chdb.result }}"
          echo "test-tpm:         ${{ needs.test-tpm.result }}"
          echo "test-hana:        ${{ needs.test-hana.result }}"
          echo "test-pg-trex:     ${{ needs.test-pg-trex.result }}"

          if [[ "${{ needs.test-distributed.result }}" == "failure" ||
                "${{ needs.test-pgwire.result }}" == "failure" ||
                "${{ needs.test-circe.result }}" == "failure" ||
                "${{ needs.test-llama.result }}" == "failure" ||
                "${{ needs.test-chdb.result }}" == "failure" ||
                "${{ needs.test-tpm.result }}" == "failure" ||
                "${{ needs.test-hana.result }}" == "failure" ||
                "${{ needs.test-pg-trex.result }}" == "failure" ]]; then
            echo "::error::One or more integration test jobs failed"
            exit 1
          fi

          echo "All required integration tests passed (or were skipped/cancelled)"
