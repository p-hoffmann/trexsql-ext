name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, ready_for_review, reopened, synchronize]
    branches: [main, develop]
  merge_group:
  workflow_dispatch:

concurrency:
  group: integration-tests-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # ===========================================================================
  # Layer 1: Build Jobs (all run in parallel)
  # ===========================================================================

  build-rust-core:
    name: "Build db"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/db/target
          key: rust-core-${{ runner.os }}-${{ hashFiles('ext/db/Cargo.lock') }}
          restore-keys: rust-core-${{ runner.os }}-

      - name: Build db
        run: make configure && make debug
        working-directory: ext/db

      - uses: actions/upload-artifact@v4
        with:
          name: ext-db
          path: ext/db/build/debug/extension/db/db.trex
          retention-days: 1

  build-pg-trex:
    name: "Build pg_trex"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - name: Install PostgreSQL 17 dev headers
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
          sudo apt-get update
          sudo apt-get install -y postgresql-17 postgresql-server-dev-17

      - name: Download libtrexsql
        run: |
          wget -O /tmp/libtrexsql.zip \
            https://github.com/p-hoffmann/trexsql-rs/releases/download/v1.4.4-trex/libtrexsql-linux-amd64.zip
          unzip /tmp/libtrexsql.zip -d /tmp/trexsql
          ln -sf /tmp/trexsql/libtrexsql.so /tmp/trexsql/libduckdb.so

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.pgrx
            ext/pg_trex/target
          key: rust-pg-trex-${{ runner.os }}-${{ hashFiles('ext/pg_trex/Cargo.lock') }}
          restore-keys: rust-pg-trex-${{ runner.os }}-

      - name: Install cargo-pgrx and init
        run: |
          cargo install cargo-pgrx --version 0.16.1 --locked
          cargo pgrx init --pg17=$(which pg_config)

      - name: Build pg_trex
        run: LIBRARY_PATH=/tmp/trexsql cargo build
        working-directory: ext/pg_trex

      - uses: actions/upload-artifact@v4
        with:
          name: pg-trex-build
          path: ext/pg_trex/target/debug/libpg_trex.so
          retention-days: 1

  build-pgwire:
    name: "Build pgwire"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/pgwire/target
          key: rust-pgwire-${{ runner.os }}-${{ hashFiles('ext/pgwire/Cargo.lock') }}
          restore-keys: rust-pgwire-${{ runner.os }}-

      - name: Build pgwire
        run: make configure && make debug
        working-directory: ext/pgwire

      - uses: actions/upload-artifact@v4
        with:
          name: ext-pgwire
          path: ext/pgwire/build/debug/extension/pgwire/pgwire.trex
          retention-days: 1

  build-chdb:
    name: "Build chdb"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - name: Install chdb native library
        run: sudo apt-get update && sudo apt-get install -y libc6-dev clang && sudo bash ./install_chdb.sh
        working-directory: ext/chdb

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/chdb/target
          key: rust-chdb-${{ runner.os }}-${{ hashFiles('ext/chdb/Cargo.lock') }}
          restore-keys: rust-chdb-${{ runner.os }}-

      - name: Build chdb
        run: make configure && make debug
        working-directory: ext/chdb

      - uses: actions/upload-artifact@v4
        with:
          name: ext-chdb
          path: ext/chdb/build/debug/extension/chdb/chdb.trex
          retention-days: 1

  build-hana:
    name: "Build hana"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/hana/target
          key: rust-hana-${{ runner.os }}-${{ hashFiles('ext/hana/Cargo.lock') }}
          restore-keys: rust-hana-${{ runner.os }}-

      - name: Build hana
        run: make configure && make debug
        working-directory: ext/hana

      - uses: actions/upload-artifact@v4
        with:
          name: ext-hana
          path: ext/hana/build/debug/extension/hana_scan/hana_scan.trex
          retention-days: 1

  build-tpm:
    name: "Build tpm"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/tpm/target
          key: rust-tpm-${{ runner.os }}-${{ hashFiles('ext/tpm/Cargo.lock') }}
          restore-keys: rust-tpm-${{ runner.os }}-

      - name: Build tpm
        run: make configure && make debug
        working-directory: ext/tpm

      - uses: actions/upload-artifact@v4
        with:
          name: ext-tpm
          path: ext/tpm/build/debug/extension/tpm/tpm.trex
          retention-days: 1

  build-trexas:
    name: "Build trexas"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/runtime/ext/trexas/target
          key: rust-trexas-${{ runner.os }}-${{ hashFiles('ext/runtime/Cargo.lock') }}
          restore-keys: rust-trexas-${{ runner.os }}-

      - name: Install trexas build dependencies
        run: sudo apt-get update && sudo apt-get install -y libopenblas-dev

      - name: Build trexas
        run: make configure && make debug
        working-directory: ext/runtime/ext/trexas

      - uses: actions/upload-artifact@v4
        with:
          name: ext-trexas
          path: ext/runtime/ext/trexas/build/debug/extension/trexas/trexas.trex
          retention-days: 1

  build-atlas:
    name: "Build atlas"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: graalvm/setup-graalvm@v1
        with:
          java-version: "21"
          components: native-image
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install circe build dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake libssl-dev xxd maven

      - uses: actions/cache@v4
        with:
          path: |
            ext/atlas/build
            ext/atlas/circe-be/target
          key: circe-${{ runner.os }}-${{ hashFiles('ext/atlas/CMakeLists.txt', 'ext/atlas/extension_config.cmake', 'ext/atlas/circe-be/pom.xml', 'ext/atlas/graalvm-config/**') }}
          restore-keys: circe-${{ runner.os }}-

      - name: Build atlas
        run: make configure && make release
        working-directory: ext/atlas

      - uses: actions/upload-artifact@v4
        with:
          name: ext-atlas
          path: ext/atlas/build/release/extension/circe/circe.trex
          retention-days: 1

  build-ai:
    name: "Build ai"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install ai build dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake libssl-dev libvulkan1 libvulkan-dev vulkan-tools glslc libshaderc1 spirv-tools vulkan-validationlayers mesa-vulkan-drivers

      - uses: actions/cache@v4
        with:
          path: ext/ai/build
          key: ai-cmake-${{ runner.os }}-${{ hashFiles('ext/ai/CMakeLists.txt', 'ext/ai/llama.cpp/CMakeLists.txt') }}
          restore-keys: ai-cmake-${{ runner.os }}-

      - name: Build ai
        run: make configure && make debug
        working-directory: ext/ai

      - uses: actions/upload-artifact@v4
        with:
          name: ext-ai
          path: ext/ai/build/debug/extension/ai/ai.trex
          retention-days: 1

  build-etl:
    name: "Build etl"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ext/etl/target
          key: rust-etl-${{ runner.os }}-${{ hashFiles('ext/etl/Cargo.lock') }}
          restore-keys: rust-etl-${{ runner.os }}-

      - name: Build etl
        run: make configure && make debug
        working-directory: ext/etl

      - uses: actions/upload-artifact@v4
        with:
          name: ext-etl
          path: ext/etl/build/debug/extension/etl/etl.trex
          retention-days: 1
    
  build-migration:
    name: "Build migration"
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ext/migration/target
          key: rust-migration-${{ runner.os }}-${{ hashFiles('ext/migration/Cargo.lock') }}
          restore-keys: rust-migration-${{ runner.os }}-

      - name: Build migration
        run: make configure && make debug
        working-directory: ext/migration

      - uses: actions/upload-artifact@v4
        with:
          name: ext-migration
          path: ext/migration/build/debug/extension/migration/migration.trex
          retention-days: 1

  # ===========================================================================
  # Layer 2: Test Jobs
  # ===========================================================================

  test-distributed:
    name: "Test distributed (tier1/2/3)"
    runs-on: ubuntu-24.04
    needs: [build-rust-core]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-db
          path: ext/db/build/debug/extension/db/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run tier1 tests
        run: venv/bin/pytest -v test_tier1_single_node.py
        working-directory: integration-tests

      - name: Run tier2 tests
        run: venv/bin/pytest -v test_tier2_two_node.py
        working-directory: integration-tests

      - name: Run tier3 tests
        run: venv/bin/pytest -v test_tier3_aggregation.py
        working-directory: integration-tests

  test-pgwire:
    name: "Test pgwire"
    runs-on: ubuntu-24.04
    needs: [build-rust-core, build-pgwire]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-db
          path: ext/db/build/debug/extension/db/

      - uses: actions/download-artifact@v4
        with:
          name: ext-pgwire
          path: ext/pgwire/build/debug/extension/pgwire/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run pgwire standalone tests
        run: venv/bin/pytest -v test_pgwire_standalone.py
        working-directory: integration-tests

      - name: Run pgwire db tests
        run: venv/bin/pytest -v test_pgwire_db.py
        working-directory: integration-tests

  test-atlas:
    name: "Test atlas"
    runs-on: ubuntu-24.04
    needs: [build-atlas]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-atlas
          path: ext/atlas/build/release/extension/circe/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run atlas standalone tests
        run: venv/bin/pytest -v test_atlas_standalone.py
        working-directory: integration-tests

  test-ai:
    name: "Test ai"
    runs-on: ubuntu-24.04
    needs: [build-ai]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-ai
          path: ext/ai/build/debug/extension/ai/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run ai standalone tests
        run: venv/bin/pytest -v test_ai_standalone.py
        working-directory: integration-tests

  test-chdb:
    name: "Test chdb"
    runs-on: ubuntu-24.04
    needs: [build-rust-core, build-chdb]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install chdb native library
        run: sudo bash ./install_chdb.sh
        working-directory: ext/chdb

      - uses: actions/download-artifact@v4
        with:
          name: ext-db
          path: ext/db/build/debug/extension/db/

      - uses: actions/download-artifact@v4
        with:
          name: ext-chdb
          path: ext/chdb/build/debug/extension/chdb/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run chdb standalone tests
        run: venv/bin/pytest -v test_chdb_standalone.py
        working-directory: integration-tests

      - name: Run chdb db tests
        run: venv/bin/pytest -v test_chdb_db.py
        working-directory: integration-tests

  test-trexas:
    name: "Test trexas"
    runs-on: ubuntu-24.04
    needs: [build-rust-core, build-trexas]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-flight
          path: flight/build/debug/extension/flight/

      - uses: actions/download-artifact@v4
        with:
          name: ext-swarm
          path: swarm/build/debug/extension/swarm/

      - uses: actions/download-artifact@v4
        with:
          name: ext-trexas
          path: ext/runtime/ext/trexas/build/debug/extension/trexas/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run trexas standalone tests
        run: venv/bin/pytest -v test_trexas_standalone.py
        working-directory: integration-tests

      - name: Run trexas swarm tests
        run: venv/bin/pytest -v test_trexas_swarm.py
        working-directory: integration-tests

  test-tpm:
    name: "Test tpm"
    runs-on: ubuntu-24.04
    needs: [build-tpm]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-tpm
          path: ext/tpm/build/debug/extension/tpm/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run tpm standalone tests
        run: venv/bin/pytest -v test_tpm_standalone.py
        working-directory: integration-tests

  test-etl:
    name: "Test etl"
    runs-on: ubuntu-24.04
    needs: [build-etl, build-rust-core]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-etl
          path: ext/etl/build/debug/extension/etl/

      - uses: actions/download-artifact@v4
        with:
          name: ext-db
          path: ext/db/build/debug/extension/db/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run etl standalone tests
        run: venv/bin/pytest -v test_etl_standalone.py
        working-directory: integration-tests

      - name: Run etl db tests
        run: venv/bin/pytest -v test_etl_db.py
        working-directory: integration-tests

  test-migration:
    name: "Test migration"
    runs-on: ubuntu-24.04
    needs: [build-migration]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-migration
          path: ext/migration/build/debug/extension/migration/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run migration standalone tests
        run: venv/bin/pytest -v test_migration_standalone.py
        working-directory: integration-tests
        
  test-hana:
    name: "Test hana"
    runs-on: ubuntu-24.04
    needs: [build-hana]
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - name: Start HANA Express container
        run: docker compose -f integration-tests/docker-compose.hana.yml up -d

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: ext-hana
          path: ext/hana/build/debug/extension/hana_scan/

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Wait for HANA to be ready
        run: |
          echo "Waiting for HANA Express to be fully ready..."
          for i in $(seq 1 120); do
            if docker logs trex-hana 2>&1 | grep -q "Startup finished!"; then
              echo "HANA startup finished after ~$((i * 5))s"
              sleep 5  # extra grace period after startup message
              exit 0
            fi
            sleep 5
          done
          echo "Timeout waiting for HANA (10 min)"
          docker logs trex-hana 2>&1 | tail -20
          exit 1

      - name: Run hana standalone tests
        run: venv/bin/pytest -v test_hana_standalone.py
        working-directory: integration-tests
        env:
          HANA_TEST_URL: "hdbsqls://SYSTEM:Toor1234@localhost:39041/HDB?insecure_omit_server_certificate_check"

      - name: Cleanup HANA container
        if: always()
        run: docker compose -f integration-tests/docker-compose.hana.yml down -v

  test-pg-trex:
    name: "Test pg_trex"
    runs-on: ubuntu-24.04
    needs: [build-rust-core, build-pg-trex]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          name: pg-trex-build
          path: ext/pg_trex/target/debug/

      - uses: actions/download-artifact@v4
        with:
          name: ext-db
          path: ext/pg_trex/extensions/

      - name: List pg_trex build context
        run: |
          ls -la ext/pg_trex/target/debug/libpg_trex.so
          ls -la ext/pg_trex/extensions/

      - name: Start pg_trex container
        run: docker compose -f integration-tests/docker-compose.pg_trex.yml up -d --build

      - name: Wait for pg_trex to be ready
        run: |
          for i in $(seq 1 30); do
            if docker exec trex-pg-trex pg_isready -U postgres 2>/dev/null; then
              echo "PostgreSQL ready after ~$((i * 2))s"
              sleep 5
              exit 0
            fi
            sleep 2
          done
          echo "Timeout waiting for PostgreSQL"
          docker logs trex-pg-trex 2>&1 | tail -30
          exit 1

      - name: Setup test environment
        run: make configure
        working-directory: integration-tests

      - name: Run pg_trex tests
        run: venv/bin/pytest -v test_pg_trex.py
        working-directory: integration-tests

      - name: Show pg_trex logs on failure
        if: failure()
        run: docker logs trex-pg-trex 2>&1 | tail -50

      - name: Cleanup
        if: always()
        run: docker compose -f integration-tests/docker-compose.pg_trex.yml down -v

  # ===========================================================================
  # Layer 3: Status Gate
  # ===========================================================================

  integration-tests-status:
    name: "Integration Tests Status"
    if: always()
    runs-on: ubuntu-24.04
    needs:
      - test-distributed
      - test-pgwire
      - test-atlas
      - test-ai
      - test-chdb
      - test-trexas
      - test-tpm
      - test-migration
      - test-hana
      - test-etl
      - test-pg-trex
    steps:
      - name: Check test results
        run: |
          echo "test-distributed: ${{ needs.test-distributed.result }}"
          echo "test-pgwire:      ${{ needs.test-pgwire.result }}"
          echo "test-atlas:       ${{ needs.test-atlas.result }}"
          echo "test-ai:          ${{ needs.test-ai.result }}"
          echo "test-chdb:        ${{ needs.test-chdb.result }}"
          echo "test-trexas:      ${{ needs.test-trexas.result }}"
          echo "test-tpm:         ${{ needs.test-tpm.result }}"
          echo "test-migration:   ${{ needs.test-migration.result }}"
          echo "test-hana:        ${{ needs.test-hana.result }}"
          echo "test-etl:         ${{ needs.test-etl.result }}"
          echo "test-pg-trex:     ${{ needs.test-pg-trex.result }}"

          if [[ "${{ needs.test-distributed.result }}" == "failure" ||
                "${{ needs.test-pgwire.result }}" == "failure" ||
                "${{ needs.test-atlas.result }}" == "failure" ||
                "${{ needs.test-ai.result }}" == "failure" ||
                "${{ needs.test-chdb.result }}" == "failure" ||
                "${{ needs.test-trexas.result }}" == "failure" ||
                "${{ needs.test-tpm.result }}" == "failure" ||
                "${{ needs.test-etl.result }}" == "failure" ||
                "${{ needs.test-pg-trex.result }}" == "failure" ||
                "${{ needs.test-migration.result }}" == "failure" ||
                "${{ needs.test-hana.result }}" == "failure" ]]; then
            echo "::error::One or more integration test jobs failed"
            exit 1
          fi

          echo "All required integration tests passed (or were skipped/cancelled)"
